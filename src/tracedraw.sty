%------------------------------
%
%   FILE: tracedraw.sty
%   Author: Guillem Ram√≠rez
%   Summary: LaTeX Package to draw timelines
%
%-----------------------------

\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{tracedraw}[2020/01/13 Trace Timeline draw Package]

% For calculations on positioning
\RequirePackage{fp}

%Synopsis
% \tracedrawHalf
% BS
\FPset\tracedrawHalf{2}

%Synopsis
% \tracedrawMaxX
% Fp var that holds the max length X
\FPset\tracedrawMaxX{10}

% Synopsis
% \tracedrawCurrentPositionX 
% Fp var that holds the X position on the timeline
\FPset\tracedrawCurrentPositionX{0}

% Synopsis
% \tracedrawCurrentPositionY 
% Fp var that holds the Y position on the timeline
\FPset\tracedrawCurrentPositionY{0}

% Synopsis
% \tracedrawChunkHeight
% Fp var that holds the Chunk height
\FPset\tracedrawChunkHeight{1}

% Synopsis
% \tracedrawSpacingHeight
% Fp var that holds the Spacing between lines height
\FPset\tracedrawSpacingHeight{0.2}

% Synopsis
% \tracedrawLineCounter
% Counter that holds the number of lines
\newcounter{tracedrawLineCounter}

% Synopsis
% \tracedrawLineNameEnabled
% Bool representing if line naming is enabled
\newif\iftracedrawLineNameEnabled
\tracedrawLineNameEnabledfalse

% Synopsis
% \tracedrawEnableLineName(Name)
% Will add before each line a the name + number of line and resets the counter to 0
\newcommand\tracedrawEnableLineName{}
\def\tracedrawEnableLineName(#1){%
  \tracedrawLineNameEnabledtrue
  \def\tracedrawLineName{#1}
}

% Synopsis
% \tracedrawMaxPercentatge
% Fp var that holds the max percentage
\FPset\tracedrawMaxPercentatge{100}

% Synopsis
% \tracedrawSetLineHeight{height}
% Set the line height to value, default: 1
\newcommand\tracedrawSetLineHeight{}
\def\tracedrawSetLineHeight(#1){%
  \FPset\tracedrawChunkHeight{#1}
}

% Synopsis
% \tracedrawSetSpacingHeight{height}
% Set the spacing height to value, default: 0.2
\newcommand\tracedrawSetSpacingHeight{}
\def\tracedrawSetSpacingHeight(#1){%
  \FPset\tracedrawSpacingHeight{#1}
}

% Synopsis
% \tracedrawNewTimeline
% Resets all the current timeline variables
\newcommand\tracedrawNewTimeline{}
\def\tracedrawNewTimeline{%
  \FPset\tracedrawCurrentPositionX{0}
  \FPset\tracedrawCurrentPositionY{0}
}

% Synopsis
% \tracedrawAddChunk[draw_options](percentage)
% Adds a chunk to the current process
\newcommand\tracedrawAddChunk{}
\def\tracedrawAddChunk[#1](#2){%

  %check if first line
  \FPifzero\tracedrawCurrentPositionX
    %check if line name enabled
    \iftracedrawLineNameEnabled

      %calc position
      \FPdiv\tracedrawHalfChunkHeight\tracedrawChunkHeight\tracedrawHalf
      \FPadd\tracedrawLabelHeight\tracedrawHalfChunkHeight\tracedrawCurrentPositionY 
      %draw the name
      \node[anchor=east] at (-0.1,\tracedrawLabelHeight) {\tracedrawLineName\ \arabic{tracedrawLineCounter}};

    \fi
  \fi
    
  %def input
  \FPset\currentPercentatge{#2}

  %calc next x
  \FPdiv\tracedrawNextPositionX\currentPercentatge\tracedrawMaxPercentatge
  \FPmul\tracedrawNextPositionX\tracedrawNextPositionX\tracedrawMaxX
  \FPadd\tracedrawNextPositionX\tracedrawNextPositionX\tracedrawCurrentPositionX

  %calc next y
  \FPadd\tracedrawNextPositionY\tracedrawCurrentPositionY\tracedrawChunkHeight

  %draw the rect
  \filldraw[#1] (\tracedrawCurrentPositionX,\tracedrawCurrentPositionY) rectangle (\tracedrawNextPositionX,\tracedrawNextPositionY);
  
  %update vars
  \FPset\tracedrawCurrentPositionX{\tracedrawNextPositionX}
}

% Synopsis
% \tracedrawNewLine
% Begins to draw a new line
\newcommand\tracedrawNewLine{}
\def\tracedrawNewLine{%

  %calc vars for spacing
  \FPadd\tracedrawCurrentPositionY\tracedrawCurrentPositionY\tracedrawChunkHeight
  \FPadd\tracedrawNextPositionY\tracedrawCurrentPositionY\tracedrawSpacingHeight

  %draw spacing
  \filldraw[color=white, fill=white] (0,\tracedrawCurrentPositionY) rectangle (\tracedrawMaxX,\tracedrawNextPositionY);

  %update vars for next line
  \FPset\tracedrawCurrentPositionX{0}
  \FPset\tracedrawCurrentPositionY{\tracedrawNextPositionY}
  \stepcounter{tracedrawLineCounter}
}

\endinput
